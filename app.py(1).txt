import streamlit as st
import pandas as pd

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø¹Ø±ÙŠØ¶ ÙˆÙ…Ù†Ø¸Ù…
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ù…ÙƒØ§ØªØ¨", layout="wide")

# ÙƒÙˆØ¯ CSS Ùˆ JavaScript Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
def add_print_button():
st.markdown(
"""
<style>
@media print {
/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.stButton, .stTextArea, .stNumberInput, .stSelectbox, .stTextInput, .stSidebar, header, [data-testid="stToolbar"] {
display: none !important;
}
.main {
width: 100% !important;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø±Ø³Ù…ÙŠ ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ø© */
table {
width: 100% !important;
border-collapse: collapse !important;
}
}
</style>
<button onclick="window.print()" style="
background-color: #2e7d32;
color: white;
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
margin-bottom: 20px;
">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
""",
unsafe_allow_html=True
)

st.title("â›½ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯")
st.write("Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.")

# --- Ù‚Ø³Ù… Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
with st.sidebar:
st.header("ğŸ“‹ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±")

# 1. Ø§Ù„Ù…ÙƒØ§ØªØ¨ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…ÙƒØ§ØªØ¨ÙƒÙ…)
liste_bureaux = ["CDD CNE ZIADIA", "BUREAU ALGER", "BUREAU ORAN", "BUREAU ANNABA", "BUREAU CONSTANTINE"]
bureau_selected = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØªØ¨:", options=liste_bureaux)

# 2. Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
n_carte_input = st.text_input("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (NÂ° Carte):", value="9887")

# 3. Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ± (Ù…ØªØºÙŠØ± ÙˆÙ„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
prix_litre = st.number_input("Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ (DA):", value=45.60, format="%.2f")

st.markdown("---")

# 4. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯
index_prec = st.number_input("Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ (INDEX DEB):", min_value=0.0, step=1.0)
index_fin = st.number_input("Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (INDEX FIN):", min_value=0.0, step=1.0)

# 5. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
solde_init = st.number_input("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ 01 (RESTE 01):", min_value=0.0, step=1.0)
chargement = st.number_input("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø´Ø­ÙˆÙ† (CHARGEMENT):", min_value=0.0, step=1.0)

# 6. Ø§Ù„Ø¨ÙˆÙ†Ø§Øª
st.subheader("â›½ Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø¨ÙˆÙ†Ø§Øª")
bons_input = st.text_area("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨Ù…Ø³Ø§ÙØ©):", help="Ù…Ø«Ø§Ù„: 2000 1500 3000")

# --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© ÙˆØ§Ù„Ø¹Ø±Ø¶ ---
# ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù…Ø¬Ø±Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if index_fin > 0:
try:
# Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙˆÙ†Ø§Øª
bons_list = [float(x) for x in bons_input.split() if x.strip()]
total_consom_da = sum(bons_list)

# Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
km_parcourus = index_fin - index_prec

# Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±
reste_31 = solde_init + chargement - total_consom_da

# Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ (L/100KM)
if km_parcourus > 0:
litres = total_consom_da / prix_litre
moyenne_val = (litres / km_parcourus) * 100
else:
moyenne_val = 0.0

# --- Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„ØµÙØ­Ø© ---
st.markdown("---")
st.subheader("ğŸ“„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")

# Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
add_print_button()

# Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø§Øª
c1, c2, c3, c4 = st.columns(4)
c1.metric("Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©", f"{km_parcourus:,.0f} KM")
c2.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ", f"{total_consom_da:,.2f} DA")
c3.metric("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ", f"{reste_31:,.2f} DA")
c4.metric("Ø§Ù„Ù…Ø¹Ø¯Ù„ (L/100)", f"{moyenne_val:.2f}")

# Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¨Ø¯ÙˆÙ† Ø³Ø¹Ø± Ø§Ù„Ù„ØªØ± ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
immat_fixe = "00341-318-25"
final_data = {
"NÂ° Carte": [n_carte_input],
"BUREAU": [bureau_selected],
"IMMATRICUL.": [immat_fixe],
"INDEX DEB": [f"{index_prec:,.0f}"],
"INDEX FIN": [f"{index_fin:,.0f}"],
"KM MOIS": [f"{km_parcourus:,.0f}"],
"MOY/100": [f"{moyenne_val:.2f}"],
"RESTE 01": [f"{solde_init:,.2f}"],
"CONS. DA": [f"{total_consom_da:,.2f}"],
"RESTE 31": [f"{reste_31:,.2f}"]
}

df = pd.DataFrame(final_data)
st.table(df) # Ø§Ø³ØªØ®Ø¯Ø§Ù… st.table Ù„Ø£Ù†Ù‡ ÙŠØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©

if km_parcourus < 0:
st.error("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")

except ValueError:
st.warning("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© ÙÙŠ Ø®Ø§Ù†Ø© Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø¨ÙˆÙ†Ø§Øª.")
else:
st.info("ğŸ’¡ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.")